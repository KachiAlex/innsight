// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenant model - all tables include tenant_id for isolation
model Tenant {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  email              String
  phone              String?
  address            String?
  branding           Json? // Logo, colors, etc.
  taxSettings        Json? // Tax rates, VAT settings
  subscriptionStatus String   @default("active") // active, suspended, cancelled
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  users                 User[]
  rooms                 Room[]
  reservations          Reservation[]
  folios                Folio[]
  payments              Payment[]
  housekeepingTasks     HousekeepingTask[]
  maintenanceTickets    MaintenanceTicket[]
  shifts                Shift[]
  audits                Audit[]
  alerts                Alert[]
  iotGateways           IoTGateway[]
  iotEvents             IoTEvent[]
  guests                Guest[]
  loyaltyProgram        LoyaltyProgram?
  depositPolicies       DepositPolicy[]
  depositPayments       DepositPayment[]
  groupBookings         GroupBooking[]
  roomBlocks            RoomBlock[]
  meetingHalls          MeetingHall[]
  groupBookingHalls     GroupBookingHallReservation[]
  overbookingSettings   OverbookingSetting[]
  overbookingAlerts     OverbookingAlert[]
  guestRequests         GuestRequest[]
  lostItems             LostItem[]
  menuCategories        MenuCategory[]
  menuItems             MenuItem[]
  roomServiceOrders     RoomServiceOrder[]
  roomServiceOrderItems RoomServiceOrderItem[]
  roomCategories        RoomCategory[]
  roomLogs              RoomLog[]
  nightAudits           NightAudit[]
  accountabilityReports AccountabilityReport[]
  analyticsMetrics      AnalyticsMetric[]
  predictiveModels      PredictiveModel[]
  workflowRules         WorkflowRule[]
  smartAlerts           SmartAlert[]
  guestBehaviors        GuestBehavior[]
  inventoryAnalytics    InventoryAnalytics[]
  RatePlan              RatePlan[]

  @@map("tenants")
}

model User {
  id           String    @id @default(uuid())
  tenantId     String
  email        String
  passwordHash String
  firstName    String
  lastName     String
  phone        String?
  role         String // owner, general_manager, front_desk, housekeeping_supervisor, housekeeping_staff, maintenance, accountant, iitech_admin
  permissions  Json? // Fine-grained permissions
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Activity tracking
  createdReservations        Reservation[]       @relation("ReservationCreator")
  checkedInReservations      Reservation[]       @relation("CheckInStaff")
  checkedOutReservations     Reservation[]       @relation("CheckOutStaff")
  createdFolios              Folio[]             @relation("FolioCreator")
  payments                   Payment[]
  assignedHousekeepingTasks  HousekeepingTask[]  @relation("AssignedHousekeepingTasks")
  completedHousekeepingTasks HousekeepingTask[]  @relation("CompletedHousekeepingTasks")
  reportedMaintenanceTickets MaintenanceTicket[] @relation("ReportedMaintenanceTickets")
  assignedMaintenanceTickets MaintenanceTicket[] @relation("AssignedMaintenanceTickets")
  resolvedMaintenanceTickets MaintenanceTicket[] @relation("ResolvedMaintenanceTickets")
  shifts                     Shift[]
  audits                     Audit[]
  resolvedAlerts             Alert[]
  createdGroupBookings       GroupBooking[]
  assignedGroupBookings      GroupBooking[]      @relation("AssignedGroupBookings")
  assignedRequests           GuestRequest[]      @relation("AssignedRequests")
  createdRequests            GuestRequest[]      @relation("RequestCreator")
  foundItems                 LostItem[]          @relation("FoundItems")
  createdItems               LostItem[]          @relation("ItemCreator")
  assignedOrders             RoomServiceOrder[]  @relation("AssignedOrders")
  createdOrders              RoomServiceOrder[]  @relation("OrderCreator")
  deliveredOrders            RoomServiceOrder[]  @relation("DeliveryStaff")
  createdWorkflowRules       WorkflowRule[]
  createdSmartAlerts         SmartAlert[]
  resolvedSmartAlerts        SmartAlert[]        @relation("AlertResolver")
  NightAudit                 NightAudit[]

  @@unique([tenantId, email])
  @@index([tenantId, role])
  @@map("users")
}

model Room {
  id           String   @id @default(uuid())
  tenantId     String
  roomNumber   String
  roomType     String // single, double, suite, etc.
  floor        Int?
  status       String   @default("available") // available, occupied, dirty, clean, inspected, out_of_order, maintenance
  maxOccupancy Int
  amenities    Json? // Array of amenities
  ratePlanId   String?
  categoryId   String?
  description  String?
  customRate   Decimal? @db.Decimal(10, 2)
  lastLogType     String?
  lastLogSummary  String?
  lastLogUserName String?
  lastLogAt       DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ratePlan           RatePlan?           @relation(fields: [ratePlanId], references: [id])
  category           RoomCategory?       @relation(fields: [categoryId], references: [id])
  reservations       Reservation[]
  folios             Folio[]
  housekeepingTasks  HousekeepingTask[]
  maintenanceTickets MaintenanceTicket[]
  iotEvents          IoTEvent[]
  iotSensors         IoTSensor[]
  roomLogs           RoomLog[]

  @@unique([tenantId, roomNumber])
  @@index([tenantId, status])
  @@index([tenantId, categoryId])
  @@map("rooms")
}

model RatePlan {
  id            String   @id @default(uuid())
  tenantId      String
  categoryId    String?
  name          String
  description   String?
  baseRate      Decimal  @db.Decimal(10, 2)
  currency      String   @default("NGN")
  seasonalRules Json? // Array of seasonal rate adjustments
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category RoomCategory? @relation(fields: [categoryId], references: [id])
  rooms    Room[]

  @@unique([tenantId, name])
  @@map("rate_plans")
}

model RoomCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  color       String?
  totalRooms  Int?     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rooms     Room[]
  ratePlans RatePlan[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("room_categories")
}

model Reservation {
  id                String    @id @default(uuid())
  tenantId          String
  roomId            String
  guestId           String? // Link to Guest table (nullable for backward compatibility)
  groupBookingId    String? // Link to group booking (nullable)
  reservationNumber String    @unique
  guestName         String
  guestEmail        String?
  guestPhone        String?
  guestIdNumber     String?
  checkInDate       DateTime
  checkOutDate      DateTime
  adults            Int       @default(1)
  children          Int       @default(0)
  status            String    @default("confirmed") // confirmed, checked_in, checked_out, cancelled, no_show
  source            String    @default("manual") // manual, web, ota, channel_manager
  rate              Decimal   @db.Decimal(10, 2)
  depositAmount     Decimal?  @db.Decimal(10, 2)
  depositStatus     String? // pending, paid, refunded, waived
  depositRequired   Boolean   @default(true)
  specialRequests   String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  checkedInAt       DateTime?
  checkedOutAt      DateTime?
  checkedInBy       String?
  checkedOutBy      String?

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room            Room             @relation(fields: [roomId], references: [id])
  guest           Guest?           @relation(fields: [guestId], references: [id])
  groupBooking    GroupBooking?    @relation(fields: [groupBookingId], references: [id])
  creator         User             @relation("ReservationCreator", fields: [createdBy], references: [id])
  checkInStaff    User?            @relation("CheckInStaff", fields: [checkedInBy], references: [id])
  checkOutStaff   User?            @relation("CheckOutStaff", fields: [checkedOutBy], references: [id])
  createdBy       String
  folios          Folio[]
  depositPayments DepositPayment[]

  @@index([tenantId, status])
  @@index([tenantId, checkInDate, checkOutDate])
  @@index([tenantId, guestId])
  @@index([tenantId, groupBookingId])
  @@index([reservationNumber])
  @@map("reservations")
}

model RoomLog {
  id        String   @id @default(uuid())
  tenantId  String
  roomId    String
  type      String
  summary   String
  details   String?
  metadata  Json?
  userId    String?
  userName  String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room   Room   @relation(fields: [roomId], references: [id])

  @@index([tenantId, roomId])
  @@index([tenantId, type])
  @@map("room_logs")
}

model NightAudit {
  id            String   @id @default(uuid())
  tenantId      String
  auditDate     DateTime
  auditDateTime DateTime
  performedBy   String?
  status        String   @default("pending")
  discrepancies Json?
  summary       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  performer User?  @relation(fields: [performedBy], references: [id])

  @@index([tenantId, auditDate])
  @@index([tenantId, status])
  @@map("night_audits")
}

model AccountabilityReport {
  id           String   @id @default(uuid())
  tenantId     String
  generatedBy  String
  lastReportAt DateTime
  flaggedCount Int      @default(0)
  noLogCount   Int      @default(0)
  staleCount   Int      @default(0)
  staleRooms   Json?
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, lastReportAt])
  @@map("accountability_reports")
}

model Folio {
  id            String    @id @default(uuid())
  tenantId      String
  reservationId String?
  roomId        String
  guestName     String
  status        String    @default("open") // open, closed, voided
  totalCharges  Decimal   @default(0) @db.Decimal(10, 2)
  totalPayments Decimal   @default(0) @db.Decimal(10, 2)
  balance       Decimal   @default(0) @db.Decimal(10, 2)
  currency      String    @default("NGN")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  closedAt      DateTime?
  closedBy      String?

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room        Room          @relation(fields: [roomId], references: [id])
  reservation Reservation?  @relation(fields: [reservationId], references: [id])
  creator     User          @relation("FolioCreator", fields: [createdBy], references: [id])
  createdBy   String
  charges     FolioCharge[]
  payments    Payment[]

  @@index([tenantId, status])
  @@index([tenantId, roomId])
  @@map("folios")
}

model FolioCharge {
  id          String   @id @default(uuid())
  folioId     String
  description String
  category    String // room_rate, extra, tax, discount, other
  amount      Decimal  @db.Decimal(10, 2)
  quantity    Int      @default(1)
  total       Decimal  @db.Decimal(10, 2)
  taxRate     Decimal? @db.Decimal(5, 2)
  taxAmount   Decimal? @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  folio Folio @relation(fields: [folioId], references: [id], onDelete: Cascade)

  @@index([folioId])
  @@map("folio_charges")
}

model Payment {
  id                   String    @id @default(uuid())
  tenantId             String
  folioId              String
  amount               Decimal   @db.Decimal(10, 2)
  method               String // card, bank_transfer, cash, other
  reference            String?   @unique
  status               String    @default("pending") // pending, completed, failed, refunded
  currency             String    @default("NGN")
  paymentGateway       String? // paystack, flutterwave, stripe, manual
  gatewayTransactionId String?
  reconciled           Boolean   @default(false)
  reconciledAt         DateTime?
  reconciledBy         String?
  notes                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  folio  Folio  @relation(fields: [folioId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  userId String

  @@index([tenantId, status])
  @@index([tenantId, reconciled])
  @@index([folioId])
  @@index([reference])
  @@map("payments")
}

model HousekeepingTask {
  id          String    @id @default(uuid())
  tenantId    String
  roomId      String
  taskType    String // cleaning, inspection, maintenance_prep
  status      String    @default("pending") // pending, in_progress, completed, skipped
  assignedTo  String?
  completedBy String?
  completedAt DateTime?
  photos      Json? // Array of photo URLs/paths
  checklist   Json? // Array of checklist items with completion status
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant         Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room           Room   @relation(fields: [roomId], references: [id])
  assignedStaff  User?  @relation("AssignedHousekeepingTasks", fields: [assignedTo], references: [id])
  completedStaff User?  @relation("CompletedHousekeepingTasks", fields: [completedBy], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, roomId])
  @@map("housekeeping_tasks")
}

model MaintenanceTicket {
  id          String    @id @default(uuid())
  tenantId    String
  roomId      String?
  title       String
  description String
  priority    String    @default("medium") // low, medium, high, urgent
  status      String    @default("open") // open, assigned, in_progress, resolved, closed
  assignedTo  String?
  reportedBy  String
  resolvedBy  String?
  resolvedAt  DateTime?
  photos      Json? // Array of photo URLs
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room          Room?  @relation(fields: [roomId], references: [id])
  reporter      User   @relation("ReportedMaintenanceTickets", fields: [reportedBy], references: [id])
  assignedStaff User?  @relation("AssignedMaintenanceTickets", fields: [assignedTo], references: [id])
  resolver      User?  @relation("ResolvedMaintenanceTickets", fields: [resolvedBy], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, priority])
  @@map("maintenance_tickets")
}

model Shift {
  id           String    @id @default(uuid())
  tenantId     String
  userId       String
  startTime    DateTime
  endTime      DateTime?
  shiftType    String // morning, afternoon, night
  cashFloat    Decimal?  @db.Decimal(10, 2)
  cashReceived Decimal?  @db.Decimal(10, 2)
  cashCounted  Decimal?  @db.Decimal(10, 2)
  variance     Decimal?  @db.Decimal(10, 2)
  status       String    @default("open") // open, closed
  notes        String?
  closedAt     DateTime?
  closedBy     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@map("shifts")
}

// Immutable audit trail
model Audit {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String?
  action      String // create_reservation, checkin, checkout, create_payment, void_folio, etc.
  entityType  String // reservation, folio, payment, room, etc.
  entityId    String
  beforeState Json? // State before action
  afterState  Json? // State after action
  metadata    Json? // Additional context (IP, user agent, etc.)
  timestamp   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId, action])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, timestamp])
  @@map("audits")
}

model Alert {
  id         String    @id @default(uuid())
  tenantId   String
  alertType  String // payment_mismatch, room_status_mismatch, suspicious_activity, etc.
  severity   String    @default("medium") // low, medium, high, critical
  title      String
  message    String
  metadata   Json? // Additional alert context
  status     String    @default("open") // open, acknowledged, resolved
  resolvedBy String?
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  resolver User?  @relation(fields: [resolvedBy], references: [id])

  @@index([tenantId, status])
  @@index([tenantId, alertType])
  @@index([tenantId, severity])
  @@map("alerts")
}

// IoT Module (optional, for future)
model IoTGateway {
  id        String    @id @default(uuid())
  tenantId  String
  gatewayId String    @unique
  name      String
  location  String?
  status    String    @default("active") // active, inactive, error
  lastSeen  DateTime?
  config    Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sensors IoTSensor[]

  @@unique([tenantId, gatewayId])
  @@map("iot_gateways")
}

model IoTSensor {
  id          String    @id @default(uuid())
  gatewayId   String
  sensorId    String
  roomId      String?
  sensorType  String // pir, thermal, door, lock
  status      String    @default("active")
  lastEventAt DateTime?
  config      Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  gateway IoTGateway @relation(fields: [gatewayId], references: [id], onDelete: Cascade)
  room    Room?      @relation(fields: [roomId], references: [id])

  @@unique([gatewayId, sensorId])
  @@index([roomId])
  @@map("iot_sensors")
}

model IoTEvent {
  id        String   @id @default(uuid())
  tenantId  String
  gatewayId String
  sensorId  String
  roomId    String?
  eventType String // occupied, vacant, door_open, door_close
  timestamp DateTime
  metadata  Json?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  room   Room?  @relation(fields: [roomId], references: [id])

  @@index([tenantId, roomId])
  @@index([tenantId, timestamp])
  @@index([sensorId])
  @@map("iot_events")
}

// ============================================
// DEPOSIT MANAGEMENT MODULE
// ============================================

// Deposit Policies - Configurable deposit rules per tenant/room type
model DepositPolicy {
  id          String  @id @default(uuid())
  tenantId    String
  name        String // e.g., "Standard Policy", "VIP Policy"
  description String?
  isActive    Boolean @default(true)

  // Application Rules
  appliesToAllRooms Boolean  @default(true)
  roomCategoryIds   String[] // Array of room category IDs this policy applies to
  ratePlanIds       String[] // Array of rate plan IDs this policy applies to

  // Deposit Calculation
  depositType      String // percentage, fixed_amount, nights, custom
  depositValue     Decimal  @db.Decimal(10, 2) // Percentage (0-100) or fixed amount
  maxDepositAmount Decimal? @db.Decimal(10, 2) // Cap for percentage-based deposits
  minDepositAmount Decimal? @db.Decimal(10, 2) // Minimum deposit required

  // Timing Rules
  dueDaysBeforeCheckIn Int // Days before check-in deposit is due
  refundableAfterDays  Int? // Days after booking when deposit becomes refundable
  cancellationFee      Decimal? @db.Decimal(5, 2) // Percentage fee on cancellation

  // Special Conditions
  requiresForWeekends   Boolean @default(false)
  requiresForHolidays   Boolean @default(false)
  requiresForPeakSeason Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@map("deposit_policies")
}

// Deposit Payments - Track individual deposit payments
model DepositPayment {
  id                   String    @id @default(uuid())
  tenantId             String
  reservationId        String
  amount               Decimal   @db.Decimal(10, 2)
  currency             String    @default("NGN")
  method               String // card, bank_transfer, cash, other
  reference            String?   @unique
  status               String    @default("pending") // pending, completed, failed, refunded
  paymentGateway       String? // paystack, flutterwave, stripe, manual
  gatewayTransactionId String?
  notes                String?
  paidAt               DateTime?
  processedBy          String?
  refundedAt           DateTime?
  refundedBy           String?
  refundAmount         Decimal?  @db.Decimal(10, 2)
  refundReason         String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, reservationId])
  @@index([reference])
  @@map("deposit_payments")
}

// ============================================
// GROUP RESERVATION MODULE
// ============================================

// Group Bookings - Master booking for groups/events
model GroupBooking {
  id                 String @id @default(uuid())
  tenantId           String
  groupBookingNumber String @unique
  groupName          String
  groupType          String // wedding, conference, tour, corporate, family, other
  contactPerson      String
  contactEmail       String
  contactPhone       String

  // Booking Details
  expectedGuests  Int
  confirmedGuests Int      @default(0)
  checkInDate     DateTime
  checkOutDate    DateTime
  totalRooms      Int

  // Financial
  totalRevenue  Decimal  @default(0) @db.Decimal(12, 2)
  depositAmount Decimal? @db.Decimal(10, 2)
  depositPaid   Boolean  @default(false)

  // Status & Progress
  status          String @default("pending") // pending, confirmed, in_progress, completed, cancelled
  bookingProgress String @default("initial_contact") // initial_contact, contract_signed, deposit_received, rooms_allocated, confirmed

  // Special Requirements
  specialRequests     String?
  dietaryRequirements String?
  setupRequirements   String?

  // Assignment
  assignedTo String? // Staff member assigned to manage this group
  createdBy  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator       User          @relation(fields: [createdBy], references: [id])
  assignedStaff User?         @relation("AssignedGroupBookings", fields: [assignedTo], references: [id])
  reservations  Reservation[]
  roomBlocks    RoomBlock[]
  hallReservations GroupBookingHallReservation[]

  @@index([tenantId, status])
  @@index([tenantId, checkInDate, checkOutDate])
  @@index([groupBookingNumber])
  @@map("group_bookings")
}

// Room Blocks - Allocated room blocks for group bookings
model RoomBlock {
  id             String @id @default(uuid())
  tenantId       String
  groupBookingId String
  roomCategoryId String
  roomType       String
  totalRooms     Int // Total rooms in this block
  allocatedRooms Int    @default(0) // Rooms actually assigned
  availableRooms Int // totalRooms - allocatedRooms

  // Pricing
  negotiatedRate  Decimal? @db.Decimal(10, 2) // Special rate for this block
  discountPercent Decimal? @db.Decimal(5, 2) // Discount percentage

  // Dates (can be subset of group booking dates)
  checkInDate  DateTime
  checkOutDate DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  groupBooking GroupBooking @relation(fields: [groupBookingId], references: [id], onDelete: Cascade)

  @@index([tenantId, groupBookingId])
  @@index([tenantId, roomCategoryId])
  @@map("room_blocks")
}

// Meeting halls / event spaces inventory
model MeetingHall {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  capacity    Int
  location    String?
  amenities   Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant          Tenant                        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  hallReservations GroupBookingHallReservation[]

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@map("meeting_halls")
}

// Hall reservations linked to a group booking
model GroupBookingHallReservation {
  id             String   @id @default(uuid())
  tenantId       String
  groupBookingId String
  hallId         String
  eventName      String?
  purpose        String?
  setupType      String?
  attendeeCount  Int?
  startDateTime  DateTime
  endDateTime    DateTime
  cateringNotes  String?
  avRequirements String?
  status         String   @default("tentative") // tentative, confirmed, completed, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  groupBooking GroupBooking @relation(fields: [groupBookingId], references: [id], onDelete: Cascade)
  hall         MeetingHall  @relation(fields: [hallId], references: [id])

  @@index([tenantId, hallId])
  @@index([tenantId, groupBookingId])
  @@index([tenantId, status])
  @@map("group_booking_halls")
}

// ============================================
// OVERBOOKING MODULE
// ============================================

// Overbooking Settings - Per room type overbooking limits
model OverbookingSetting {
  id             String  @id @default(uuid())
  tenantId       String
  roomCategoryId String? // If null, applies to all categories
  roomType       String? // If null, applies to all room types

  // Overbooking Limits
  maxOverbookingPercent Decimal @default(10) @db.Decimal(5, 2) // Max 10% overbooking
  maxOverbookingCount   Int? // Alternative: fixed number instead of percentage

  // Alert Thresholds
  alertThresholdPercent    Decimal @default(5) @db.Decimal(5, 2) // Alert at 5% overbooking
  criticalThresholdPercent Decimal @default(8) @db.Decimal(5, 2) // Critical alert at 8%

  // Restrictions
  allowOverbooking       Boolean    @default(false)
  requireManagerApproval Boolean    @default(true)
  blackoutDates          DateTime[] // Dates when overbooking is not allowed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, roomCategoryId, roomType])
  @@index([tenantId])
  @@map("overbooking_settings")
}

// Overbooking Alerts - Track overbooking situations
model OverbookingAlert {
  id                 String   @id @default(uuid())
  tenantId           String
  roomCategoryId     String
  roomType           String
  date               DateTime // Date of overbooking
  totalRooms         Int // Total rooms available
  bookedRooms        Int // Confirmed bookings
  overbookedRooms    Int // Number of overbookings
  overbookingPercent Decimal  @db.Decimal(5, 2)

  // Resolution
  status          String    @default("active") // active, resolved, escalated
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, date])
  @@index([tenantId, status])
  @@map("overbooking_alerts")
}

// ============================================
// GUEST REQUESTS MODULE
// ============================================

// Guest Requests - Service requests from guests
model GuestRequest {
  id            String  @id @default(uuid())
  tenantId      String
  guestId       String? // Link to guest if known
  reservationId String? // Link to reservation if applicable
  roomId        String? // Room making the request

  // Request Details
  requestType String // amenities, maintenance, housekeeping, concierge, other
  priority    String @default("normal") // low, normal, high, urgent
  title       String
  description String
  status      String @default("pending") // pending, assigned, in_progress, completed, cancelled

  // Contact Information
  guestName  String?
  guestPhone String?
  guestEmail String?
  roomNumber String?

  // Assignment & Resolution
  assignedTo          String? // Staff member assigned
  department          String? // housekeeping, maintenance, concierge, front_desk
  estimatedCompletion DateTime?
  actualCompletion    DateTime?

  // Communication
  guestNotified   Boolean   @default(false)
  lastGuestUpdate DateTime?

  // Metadata
  source String   @default("manual") // manual, app, kiosk, phone
  tags   String[] // Array of tags for categorization

  createdBy String // Staff who created the request
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  guest         Guest? @relation(fields: [guestId], references: [id])
  assignedStaff User?  @relation("AssignedRequests", fields: [assignedTo], references: [id])
  creator       User   @relation("RequestCreator", fields: [createdBy], references: [id])

  messages GuestRequestMessage[]
  updates  GuestRequestUpdate[]

  @@index([tenantId, status])
  @@index([tenantId, priority])
  @@index([tenantId, requestType])
  @@index([tenantId, guestId])
  @@index([tenantId, assignedTo])
  @@map("guest_requests")
}

// Guest Request Messages - Communication thread
model GuestRequestMessage {
  id               String  @id @default(uuid())
  tenantId         String
  guestRequestId   String
  message          String
  messageType      String  @default("note") // note, update, resolution, guest_response
  isFromGuest      Boolean @default(false)
  isVisibleToGuest Boolean @default(false)

  createdBy String? // Staff member or null for guest messages
  createdAt DateTime @default(now())

  guestRequest GuestRequest @relation(fields: [guestRequestId], references: [id], onDelete: Cascade)

  @@index([tenantId, guestRequestId])
  @@map("guest_request_messages")
}

// Guest Request Updates - Status change history
model GuestRequestUpdate {
  id             String  @id @default(uuid())
  tenantId       String
  guestRequestId String
  previousStatus String
  newStatus      String
  updateType     String // status_change, assignment, priority_change, notes
  notes          String?
  performedBy    String

  createdAt DateTime @default(now())

  guestRequest GuestRequest @relation(fields: [guestRequestId], references: [id], onDelete: Cascade)

  @@index([tenantId, guestRequestId])
  @@map("guest_request_updates")
}

// ============================================
// LOST & FOUND MODULE
// ============================================

// Lost Items - Items reported lost by guests
model LostItem {
  id         String @id @default(uuid())
  tenantId   String
  itemNumber String @unique // Auto-generated item number

  // Item Details
  itemName     String
  description  String
  category     String // electronics, clothing, jewelry, documents, other
  color        String?
  brand        String?
  serialNumber String?
  value        Decimal? @db.Decimal(10, 2)

  // Location & Circumstances
  foundLocation String // room_number, lobby, restaurant, pool, parking, other
  foundBy       String? // Staff member who found it
  foundAt       DateTime
  circumstances String? // How/where it was found

  // Guest Information (if reported lost)
  reportedByGuestId String?
  reportedByName    String?
  reportedByPhone   String?
  reportedByEmail   String?
  reportedByRoom    String?
  reportedAt        DateTime?

  // Current Status
  status          String  @default("unclaimed") // unclaimed, claimed, returned, disposed, donated
  storageLocation String? // Where the item is stored
  storageNotes    String?

  // Resolution
  claimedBy    String? // Guest who claimed it
  claimedAt    DateTime?
  claimMethod  String? // id_check, description_match, other
  returnedTo   String? // Guest contact info for return
  returnMethod String? // hand_delivered, mailed, picked_up

  // Disposal
  disposedAt     DateTime?
  disposedBy     String?
  disposalMethod String? // donated, discarded, sold

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  foundStaff    User?  @relation("FoundItems", fields: [foundBy], references: [id])
  reportedGuest Guest? @relation(fields: [reportedByGuestId], references: [id])
  creator       User   @relation("ItemCreator", fields: [createdBy], references: [id])

  @@unique([tenantId, itemNumber])
  @@index([tenantId, status])
  @@index([tenantId, category])
  @@index([tenantId, foundAt])
  @@map("lost_items")
}

// ============================================
// ROOM SERVICE MODULE
// ============================================

// Menu Categories - Organize menu items
model MenuCategory {
  id           String  @id @default(uuid())
  tenantId     String
  name         String
  description  String?
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)
  imageUrl     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  MenuItem[]

  @@unique([tenantId, name])
  @@index([tenantId, isActive])
  @@map("menu_categories")
}

// Menu Items - Individual food/drink items
model MenuItem {
  id         String @id @default(uuid())
  tenantId   String
  categoryId String

  name            String
  description     String?
  price           Decimal  @db.Decimal(8, 2)
  imageUrl        String?
  isActive        Boolean  @default(true)
  isVegetarian    Boolean  @default(false)
  isVegan         Boolean  @default(false)
  isGlutenFree    Boolean  @default(false)
  containsNuts    Boolean  @default(false)
  spiceLevel      String   @default("mild") // mild, medium, hot, very_hot
  preparationTime Int? // Minutes to prepare
  allergens       String[] // Array of allergens

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  orderItems RoomServiceOrderItem[]

  @@index([tenantId, isActive])
  @@index([tenantId, categoryId])
  @@map("menu_items")
}

// Room Service Orders - Guest orders
model RoomServiceOrder {
  id          String @id @default(uuid())
  tenantId    String
  orderNumber String @unique

  // Guest Information
  guestId    String?
  guestName  String
  roomNumber String
  guestPhone String?

  // Order Details
  status              String    @default("pending") // pending, confirmed, preparing, ready, delivered, cancelled
  orderType           String    @default("room_service") // room_service, in_room_dining, lounge_order
  specialInstructions String?
  estimatedDelivery   DateTime?

  // Financial
  subtotal      Decimal @default(0) @db.Decimal(8, 2)
  taxAmount     Decimal @default(0) @db.Decimal(8, 2)
  serviceCharge Decimal @default(0) @db.Decimal(8, 2)
  totalAmount   Decimal @default(0) @db.Decimal(8, 2)

  // Delivery
  deliveredAt   DateTime?
  deliveredBy   String?
  deliveryNotes String?

  // Assignment
  assignedTo String? // Kitchen staff
  preparedAt DateTime?

  // Timestamps
  requestedAt DateTime  @default(now())
  confirmedAt DateTime?
  createdBy   String? // Staff who took the order
  updatedAt   DateTime  @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  guest         Guest? @relation(fields: [guestId], references: [id])
  assignedStaff User?  @relation("AssignedOrders", fields: [assignedTo], references: [id])
  creator       User?  @relation("OrderCreator", fields: [createdBy], references: [id])
  deliveryStaff User?  @relation("DeliveryStaff", fields: [deliveredBy], references: [id])

  items RoomServiceOrderItem[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId, status])
  @@index([tenantId, requestedAt])
  @@index([tenantId, roomNumber])
  @@map("room_service_orders")
}

// Order Items - Individual items in an order
model RoomServiceOrderItem {
  id         String @id @default(uuid())
  tenantId   String
  orderId    String
  menuItemId String

  quantity        Int
  unitPrice       Decimal @db.Decimal(8, 2)
  totalPrice      Decimal @db.Decimal(8, 2)
  specialRequests String?

  // Preparation status
  status     String    @default("pending") // pending, preparing, ready, delivered
  preparedAt DateTime?

  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order    RoomServiceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem MenuItem         @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([tenantId, orderId])
  @@index([tenantId, status])
  @@map("room_service_order_items")
}

// ============================================
// ANALYTICS & BUSINESS INTELLIGENCE MODULE
// ============================================

// Analytics Dashboard Metrics - Pre-calculated KPIs
model AnalyticsMetric {
  id         String @id @default(uuid())
  tenantId   String
  metricKey  String // revenue, occupancy, guest_satisfaction, etc.
  metricName String
  category   String // financial, operational, guest_experience, inventory

  // Value and metadata
  value         Decimal? @db.Decimal(12, 2)
  previousValue Decimal? @db.Decimal(12, 2)
  changePercent Decimal? @db.Decimal(8, 2)
  targetValue   Decimal? @db.Decimal(12, 2)
  status        String   @default("normal") // normal, warning, critical, excellent

  // Time period
  periodType  String   @default("daily") // hourly, daily, weekly, monthly, yearly
  periodStart DateTime
  periodEnd   DateTime

  // Additional data
  metadata       Json? // Chart data, breakdowns, etc.
  lastCalculated DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metricKey, periodType, periodStart])
  @@index([tenantId, category])
  @@index([tenantId, periodType, periodStart])
  @@map("analytics_metrics")
}

// Predictive Models - ML model storage and results
model PredictiveModel {
  id        String @id @default(uuid())
  tenantId  String
  modelType String // guest_preference, demand_forecast, price_optimization
  modelName String
  version   String

  // Model data
  modelData        Json? // Serialized model parameters
  accuracy         Decimal?  @db.Decimal(5, 2) // Model accuracy percentage
  lastTrained      DateTime?
  trainingDataSize Int?

  // Predictions
  isActive   Boolean  @default(true)
  confidence Decimal? @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, modelType])
  @@index([tenantId, isActive])
  @@map("predictive_models")
}

// Automated Workflows - Smart task assignment rules
model WorkflowRule {
  id       String @id @default(uuid())
  tenantId String
  ruleName String
  ruleType String // assignment, escalation, notification, automation

  // Trigger conditions
  triggerEvent String // reservation_created, guest_request, maintenance_issue
  conditions   Json? // Complex condition logic

  // Actions to take
  actions  Json? // What to do when triggered
  priority Int   @default(0)

  // Execution
  isActive       Boolean   @default(true)
  lastExecuted   DateTime?
  executionCount Int       @default(0)

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator User   @relation(fields: [createdBy], references: [id])

  @@index([tenantId, ruleType])
  @@index([tenantId, triggerEvent])
  @@index([tenantId, isActive])
  @@map("workflow_rules")
}

// Real-time Alerts - Automated notifications
model SmartAlert {
  id        String @id @default(uuid())
  tenantId  String
  alertType String // occupancy_drop, revenue_decline, service_delay
  severity  String @default("info") // info, warning, critical

  title       String
  message     String
  description String?

  // Trigger conditions
  threshold  Json? // When to trigger
  conditions Json?

  // Recipients and channels
  notifyUsers String[] // User IDs to notify
  notifyRoles String[] // Role names to notify
  channels    String[] @default(["dashboard"]) // dashboard, email, sms, push

  // Status
  status      String    @default("active") // active, triggered, resolved, disabled
  triggeredAt DateTime?
  resolvedAt  DateTime?
  resolvedBy  String?

  // Auto-resolution
  autoResolve         Boolean @default(false)
  resolveAfterMinutes Int?

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator  User   @relation(fields: [createdBy], references: [id])
  resolver User?  @relation("AlertResolver", fields: [resolvedBy], references: [id])

  @@index([tenantId, alertType])
  @@index([tenantId, status])
  @@index([tenantId, severity])
  @@map("smart_alerts")
}

// Guest Behavior Analytics - Track patterns and preferences
model GuestBehavior {
  id       String  @id @default(uuid())
  tenantId String
  guestId  String?

  // Behavior data
  behaviorType  String // room_preference, dining_preference, service_usage
  behaviorKey   String // specific behavior identifier
  behaviorValue String // preference value
  confidence    Decimal @default(1) @db.Decimal(5, 2) // How confident we are

  // Tracking
  firstObserved    DateTime
  lastObserved     DateTime
  observationCount Int      @default(1)

  // Context
  contextData Json? // Additional context about the behavior

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  guest  Guest? @relation(fields: [guestId], references: [id])

  @@index([tenantId, behaviorType])
  @@index([tenantId, guestId])
  @@index([tenantId, behaviorKey])
  @@map("guest_behaviors")
}

// Inventory Analytics - Smart inventory tracking
model InventoryAnalytics {
  id       String @id @default(uuid())
  tenantId String
  itemType String // amenities, linens, cleaning_supplies, food
  itemId   String // Reference to the actual item

  // Usage patterns
  dailyUsage   Decimal @default(0) @db.Decimal(8, 2)
  weeklyUsage  Decimal @default(0) @db.Decimal(8, 2)
  monthlyUsage Decimal @default(0) @db.Decimal(8, 2)

  // Predictions
  predictedDailyUsage  Decimal? @db.Decimal(8, 2)
  predictedWeeklyUsage Decimal? @db.Decimal(8, 2)
  reorderPoint         Decimal? @db.Decimal(8, 2)

  // Alerts
  lowStockAlert  Boolean @default(false)
  overStockAlert Boolean @default(false)

  lastCalculated  DateTime  @default(now())
  nextReorderDate DateTime?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, itemType, itemId])
  @@index([tenantId, itemType])
  @@index([tenantId, lowStockAlert])
  @@map("inventory_analytics")
}

// ============================================
// GUEST MANAGEMENT MODULE
// ============================================

// Dedicated Guest table - stores unique guest records
model Guest {
  id       String @id @default(uuid())
  tenantId String

  name        String
  email       String?
  phone       String?
  idNumber    String?
  dateOfBirth DateTime?
  nationality String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?

  // Loyalty & Status
  loyaltyTier   String  @default("bronze") // bronze, silver, gold, platinum, vip
  loyaltyPoints Int     @default(0)
  totalStays    Int     @default(0)
  totalNights   Int     @default(0)
  totalSpent    Decimal @default(0) @db.Decimal(12, 2)

  // Preferences
  preferredRoomType String?
  preferredFloor    Int?
  smokingPreference Boolean @default(false)
  bedPreference     String? // king, queen, twin, etc.
  pillowPreference  String? // soft, medium, firm

  // Dietary & Special
  dietaryRestrictions Json? // Array of dietary restrictions
  allergies           Json? // Array of allergies
  specialRequests     String?

  // Guest Flags
  isVIP        Boolean   @default(false)
  isBanned     Boolean   @default(false)
  bannedReason String?
  bannedAt     DateTime?

  // Marketing
  marketingOptIn Boolean @default(true)
  emailOptIn     Boolean @default(true)
  smsOptIn       Boolean @default(true)

  // Dates
  firstStayDate DateTime?
  lastStayDate  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  reservations        Reservation[]
  activityLogs        GuestActivityLog[]
  notes               GuestNote[]
  loyaltyTransactions LoyaltyTransaction[]
  guestRequests       GuestRequest[]
  lostItems           LostItem[]
  roomServiceOrders   RoomServiceOrder[]
  guestBehaviors      GuestBehavior[]

  @@unique([tenantId, email])
  @@unique([tenantId, phone])
  @@index([tenantId, loyaltyTier])
  @@index([tenantId, isVIP])
  @@index([tenantId, email])
  @@index([tenantId, phone])
  @@map("guests")
}

// Guest Activity Log - tracks all guest interactions
model GuestActivityLog {
  id           String   @id @default(uuid())
  tenantId     String
  guestId      String
  activityType String // check_in, check_out, reservation, cancellation, payment, complaint, request, note, loyalty_earned, loyalty_redeemed
  title        String // Brief description
  description  String? // Detailed description
  metadata     Json? // Additional context (reservation ID, room number, amount, etc.)
  performedBy  String? // Staff member who performed/logged the action
  createdAt    DateTime @default(now())

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([tenantId, guestId, createdAt])
  @@index([tenantId, activityType])
  @@map("guest_activity_logs")
}

// Guest Notes - staff observations and notes
model GuestNote {
  id          String   @id @default(uuid())
  tenantId    String
  guestId     String
  noteType    String   @default("general") // general, complaint, compliment, special_request, vip, warning
  note        String
  isImportant Boolean  @default(false)
  isPinned    Boolean  @default(false)
  createdBy   String // Staff member who created the note
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([tenantId, guestId, createdAt])
  @@index([tenantId, isImportant])
  @@index([tenantId, isPinned])
  @@map("guest_notes")
}

// Loyalty Program Configuration - per tenant
model LoyaltyProgram {
  id          String  @id @default(uuid())
  tenantId    String  @unique
  isActive    Boolean @default(true)
  programName String  @default("InnSight Rewards")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Points Configuration
  pointsPerNight    Int     @default(10) // Points earned per night
  pointsPerCurrency Decimal @default(1) @db.Decimal(10, 2) // Points per currency unit spent

  // Tier Thresholds (points required)
  silverThreshold   Int @default(100)
  goldThreshold     Int @default(500)
  platinumThreshold Int @default(1000)
  vipThreshold      Int @default(5000)

  // Tier Benefits (discount percentages)
  bronzeDiscount   Decimal @default(0) @db.Decimal(5, 2)
  silverDiscount   Decimal @default(5) @db.Decimal(5, 2)
  goldDiscount     Decimal @default(10) @db.Decimal(5, 2)
  platinumDiscount Decimal @default(15) @db.Decimal(5, 2)
  vipDiscount      Decimal @default(20) @db.Decimal(5, 2)

  // Redemption
  pointsRedemptionRate Decimal @default(100) @db.Decimal(10, 2) // Points needed for 1 unit of currency
  minRedemptionPoints  Int     @default(500) // Minimum points to redeem

  // Expiry
  pointsExpiryMonths Int? // Points expire after X months (null = never)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("loyalty_programs")
}

// Loyalty Transactions - track points earned and redeemed
model LoyaltyTransaction {
  id              String   @id @default(uuid())
  tenantId        String
  guestId         String
  transactionType String // earned, redeemed, expired, adjusted
  points          Int // Positive for earned, negative for redeemed/expired
  balanceBefore   Int // Points balance before transaction
  balanceAfter    Int // Points balance after transaction
  description     String
  reservationId   String? // Link to reservation if applicable
  metadata        Json? // Additional context (rate, nights, discount applied, etc.)
  createdBy       String? // Staff member who performed the transaction
  createdAt       DateTime @default(now())

  guest Guest @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@index([tenantId, guestId, createdAt])
  @@index([tenantId, transactionType])
  @@map("loyalty_transactions")
}
